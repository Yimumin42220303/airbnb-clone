// Prisma 스키마 - 숙박 예약 플랫폼 DB 설계
// Supabase(PostgreSQL) 또는 로컬 PostgreSQL 사용

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ---------- 사용자 ----------
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?   // 이메일 회원가입 시 해시된 비밀번호 (OAuth 사용자는 null)
  emailVerified DateTime? // 이메일 인증 완료 시각 (인증 전 null)
  name          String?
  image         String?
  phone         String?   // 전화번호 (선택)
  role          String    @default("user") // "user" | "admin"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]  // NextAuth OAuth·이메일 연동
  sessions Session[]  // NextAuth 세션 (JWT 사용 시 미사용 가능)
  listings Listing[]  // 호스트로 등록한 숙소
  bookings Booking[]
  reviews  Review[]
  messagesSent Message[]
  wishlists Wishlist[]
  posts    Post[]   // 운영자 블로그 (admin 전용)
}

// NextAuth OAuth·이메일 연동
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token                  String?
  session_state             String?
  refresh_token_expires_in  Int?    // 카카오 OAuth용

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// NextAuth 이메일 매직 링크
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
}

// ---------- 블로그 (SEO·운영자 전용) ----------
model Post {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique  // URL용 (예: tokyo-minbak-guide)
  excerpt     String?   // 메타 설명·목록 요약
  body        String
  coverImage  String?   // 대표 이미지 URL
  publishedAt DateTime? // null = 비공개(초안)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([publishedAt])
  @@index([slug])
}

// ---------- 숙소 ----------
model Listing {
  id          String   @id @default(cuid())
  title       String
  location    String   // 예: "신주쿠구, 도쿄" 또는 "다카다노바바역 도보 6분"
  description String? @default("")
  /// 구글 지도 등 외부 지도 서비스 링크 (선택)
  mapUrl      String?
  pricePerNight Int    // 1박 가격 (원)
  cleaningFee   Int    @default(0) // 청소비 (원, 1회)
  imageUrl    String   // 대표 이미지 URL
  /// 기본 요금에 포함되는 인원 수 (명)
  baseGuests  Int      @default(2)
  /// 최대 인원 수 (명)
  maxGuests   Int      @default(2)
  /// 기본 인원 초과 1인당 1박 추가 요금 (원)
  extraGuestFee Int    @default(0)
  /// 월별 요금 배수 (기본 1.0). 예: 1월=1.1이면 1월은 기본 요금의 110%
  januaryFactor   Float @default(1.0)
  februaryFactor  Float @default(1.0)
  marchFactor     Float @default(1.0)
  aprilFactor     Float @default(1.0)
  mayFactor       Float @default(1.0)
  juneFactor      Float @default(1.0)
  julyFactor      Float @default(1.0)
  augustFactor    Float @default(1.0)
  septemberFactor Float @default(1.0)
  octoberFactor   Float @default(1.0)
  novemberFactor  Float @default(1.0)
  decemberFactor  Float @default(1.0)
  bedrooms    Int      @default(1)
  beds        Int      @default(1)
  baths       Int      @default(1)
  isPromoted  Boolean  @default(false) // 직영숙소(프로모션대상) 여부
  /// 취소 정책: "flexible" | "moderate" | "strict"
  cancellationPolicy String @default("flexible")
  /// 주의사항 (줄바꿈으로 구분, 각 줄이 하나의 항목)
  houseRules  String?  @default("")
  /// 숙소 타입: "detached_house"(단독주택) | "apartment"(아파트)
  propertyType String? @default("apartment")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  categoryId String?
  category   ListingCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // OTA/PMS 캘린더 연동 (임시: iCal/ICS. 추후 Beds24 등 API 연동 시 동일 blocked-dates 파이프라인 사용)
  icalImportUrls String? @default("[]") // JSON array of ICS URLs to import (Airbnb, Beds24 export, etc.)

  bookings     Booking[]
  reviews      Review[]
  listingAmenities ListingAmenity[]
  images       ListingImage[]
  availability ListingAvailability[]
  wishlists    Wishlist[]

  @@index([userId]) // 호스트별 숙소 조회 최적화
}

// 위시리스트 (찜)
model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, listingId])
  @@index([userId])
}

// 날짜별 요금·예약 불가
model ListingAvailability {
  id             String   @id @default(cuid())
  listingId      String
  listing        Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  date           String   // YYYY-MM-DD
  pricePerNight  Int?     // null이면 숙소 기본 요금 사용
  available      Boolean  @default(true) // false면 예약 불가

  @@unique([listingId, date])
  @@index([listingId])
}

// 숙소 이미지 (다중)
model ListingImage {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  sortOrder Int      @default(0)

  @@index([listingId])
}

// ---------- 숙소 카테고리 (도미토리, 개인실, 아파트 등, Framer CMS처럼 등록 시 새로 만들기 가능) ----------
model ListingCategory {
  id        String   @id @default(cuid())
  name      String   @unique  // 예: "도미토리", "개인실", "콘도"
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  listings Listing[]
}

// ---------- 편의시설 (WiFi, 주방 등) ----------
model Amenity {
  id   String @id @default(cuid())
  name String @unique // 예: "WiFi", "주방", "TV"
  icon String?        // 이모지 또는 아이콘명

  listings ListingAmenity[]
}

// 숙소 ↔ 편의시설 다대다
model ListingAmenity {
  listingId String
  amenityId String

  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  amenity Amenity @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([listingId, amenityId])
}

// ---------- 예약 ----------
model Booking {
  id              String   @id @default(cuid())
  checkIn         DateTime
  checkOut        DateTime
  guests          Int      @default(1)
  totalPrice      Int      // 총 결제 금액
  status          String   @default("pending") // pending | confirmed | cancelled
  paymentStatus   String   @default("pending") // pending | paid | refunded | failed
  rejectedByHost  Boolean? @default(false) // 취소 시 호스트 거절 여부 (기록용)
  billingKey            String?   // 포트원 빌링키 (카드 등록 시 발급)
  paymentMethod         String    @default("immediate") // immediate(즉시결제) | deferred(빌링키 후불결제)
  scheduledPaymentDate  DateTime? // 자동 결제 예정일 (체크인 7일 전)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversation Conversation?
  transactions PaymentTransaction[]

  @@index([listingId, checkIn, checkOut]) // 예약 가능 여부 검색용
  @@index([status, paymentStatus])        // 상태별 조회 최적화
  @@index([userId])                        // 사용자별 예약 조회
  @@index([paymentMethod, paymentStatus, scheduledPaymentDate]) // Cron Job 빌링키 결제 조회용
}

// ---------- 결제 트랜잭션 (포트원 결제 이력) ----------
model PaymentTransaction {
  id              String   @id @default(cuid())
  bookingId       String
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  paymentId       String   @unique // 포트원 paymentId (결제창 요청 시 생성한 ID)
  transactionId   String?  // 포트원 transactionId (PG사 응답)
  amount          Int      // 결제 금액
  status          String   @default("pending") // pending | paid | failed | cancelled | refunded
  method          String?  // CARD, VIRTUAL_ACCOUNT 등
  pgProvider      String?  // KG이니시스 등
  failReason      String?  // 실패/취소 사유
  rawResponse     String?  // 포트원 응답 원본 JSON
  verifiedAt      DateTime? // 서버 측 검증 완료 시각
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([bookingId])
  @@index([paymentId])
}

// ---------- 메시지 (예약 단위 대화) ----------
model Conversation {
  id        String   @id @default(cuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  messages Message[]
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  body           String
  createdAt      DateTime @default(now())

  @@index([conversationId, createdAt])
}

// AI 리뷰 요약 캐시 (온디맨드 생성, 24시간 유효)
model ListingReviewSummary {
  id                 String   @id @default(cuid())
  listingId          String   @unique
  prosJson           String   // JSON array of strings (좋은 점)
  consJson           String   // JSON array of strings (아쉬운 점)
  recommendedForJson  String?  // JSON array of strings (이런 분에게 추천해요)
  generatedAt        DateTime @updatedAt
}

// ---------- 리뷰 ----------
model Review {
  id        String   @id @default(cuid())
  rating   Int      // 1~5
  body     String?
  createdAt DateTime @default(now())
  /// 어드민이 편집한 게스트 표시 이름 (없으면 user.name 사용)
  authorDisplayName String?

  listingId String
  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  // 과거에는 @@unique([listingId, userId]) 로 "숙소당 사용자 1인 1리뷰"를 강제했지만,
  // 관리자(admin)가 동일 숙소에 여러 리뷰를 등록할 수 있도록 제거했습니다.
  @@index([listingId, userId])
}
