# 포트원(KG이니시스) PG 설정 가이드

이 프로젝트의 **예약 확인·결제 페이지**에서 카드/간편결제를 사용하려면 포트원에 PG 채널을 연동하고, 발급받은 값을 `.env`에 넣어야 합니다.

---

## 1. 포트원 가입 및 로그인

1. **[포트원](https://portone.io)** 접속 후 회원가입/로그인
2. **[관리자 콘솔](https://admin.portone.io/)** 접속

---

## 2. Store ID 확인

1. **[관리자 콘솔](https://admin.portone.io/)** 로그인
2. **상점·계정관리**(또는 **상점 계정 관리**) 메뉴로 이동
3. 페이지 **우측 상단**의 **「내 식별코드, API Keys」** 버튼 클릭
4. 표시되는 **가맹점 식별 코드**(또는 **Store ID**)를 복사

- **형식:** `store-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- 가입 시 자동 발급되는 상점 구분용 고유 값이며, 결제 요청 시 `storeId`로 사용합니다.

---

## 3. 채널 추가 (KG이니시스 연동)

**경로:** [관리자 콘솔](https://admin.portone.io/) → **결제연동** → **채널관리** → **+ 채널추가**

### 3-1. 테스트 연동 (개발/테스트용, 계약 없이 사용)

KG이니시스와 **실계약 전**에 결제창 연동을 테스트할 때 사용합니다.

| 항목 | 선택/입력 값 |
|------|----------------|
| **연동모드** | 테스트연동 |
| **결제대행사** | KG이니시스 |
| **결제모듈** | **결제창 일반/정기결제 및 API 수기/정기결제 및 해외결제(일본)** (V2 권장) |
| **채널이름** | 임의 입력 (예: `KG이니시스-테스트`) — 영문, 숫자, `_`, `-` 만 가능 |
| **채널속성** | 결제 |
| **PG상점아이디 (MID)** | **일반결제용:** `INIpayTest` 선택 / **정기결제용:** `INIBillTst` 선택 |

저장 후 생성된 채널의 **Channel Key**를 복사해 둡니다.

**테스트 모드 참고:**
- 실제 출금되지만 **매일 23:00~23:50** 사이 자동 취소됩니다.
- 카카오페이·네이버페이는 창에는 보이지만, 실제 사용은 이니시스 계약 시 서비스 신청한 고객사만 가능합니다.
- **국민카드**(카카오뱅크 등)는 테스트 결제 미지원입니다.

### 3-2. 실 연동 (운영용, KG이니시스 계약 후)

KG이니시스와 **실계약**을 한 뒤 사용합니다.

| 항목 | 선택/입력 값 |
|------|----------------|
| **연동모드** | 실연동 |
| **결제대행사** | KG이니시스 |
| **결제모듈** | 결제창 일반/정기결제 ㅣ API 일반/정기결제 |
| **채널이름** | 임의 입력 (예: `KG이니시스-운영`) |
| **채널속성** | 결제 |
| **PG상점아이디 (MID)** | KG이니시스에서 발급받은 상점아이디 입력 |
| **웹표준결제 signkey** | [KG이니시스 상점관리자](https://iniweb.inicis.com/security/login.do) → 로그인 → 상점정보 → 부가정보 → **웹 signkey 생성·조회**에서 [조회] 후 입력 |
| **INIAPI key** (V2 필수) | KG이니시스 상점관리자 → 상점정보 → 부가정보 → **INIAPI key 생성·갱신**에서 [조회] 후 입력 |

- **카드사 심사**가 완료된 MID여야 결제가 정상 동작합니다.
- 채널 저장 후 해당 채널의 **Channel Key**를 복사해 둡니다.

---

## 4. Channel Key 확인

- **채널관리** 목록에서 방금 만든 채널을 클릭하면 **채널 키(Channel Key)**가 표시됩니다.
- 형식: `channel-key-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
- 이 값은 결제 요청 시 `channelKey`로 사용합니다.

---

## 5. .env에 넣기

프로젝트 **루트**의 `.env` 파일에 아래 값을 추가합니다. (본인 값으로 교체)

```env
# 포트원(KG이니시스) PG - 예약 확인·호스트 승인 후 결제
NEXT_PUBLIC_PORTONE_STORE_ID="store-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
NEXT_PUBLIC_PORTONE_CHANNEL_KEY="channel-key-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
# 결제 검증용 (서버 전용) - 포트원 콘솔 → API Keys → V2 Secret Key
PORTONE_API_SECRET="portone-api-secret-xxxxxxxx"
```

- `NEXT_PUBLIC_` 접두사가 있어야 브라우저(결제창)에서 사용할 수 있습니다.
- **PORTONE_API_SECRET**은 결제 완료 후 서버에서 포트원 API로 검증할 때 필요합니다. 없으면 「결제 검증에 실패했습니다」가 날 수 있습니다.
- 수정 후 **개발 서버를 재시작**해야 반영됩니다. (`npm run dev` 중지 후 다시 실행)
- **Vercel 배포 시**: 위 세 변수를 모두 **Production** 환경에 설정하고, 포트원 채널에 **실제 서비스 URL**(또는 `*.vercel.app`)을 등록해야 결제가 동작합니다.

---

## 6. 이 프로젝트에서 동작 방식

- **예약 확인 페이지** (`/booking/confirm`)에서 결제 수단을 **카드·간편결제(KG이니시스)**로 선택하면, 위 두 값이 있을 때만 **결제하기** 버튼이 활성화됩니다.
- 버튼 클릭 시 예약 생성 후 **포트원 결제창**이 열리고, 결제 완료 시 예약 완료 페이지로 이동합니다.
- `.env`에 두 값이 없으면 카드 결제는 비활성화되고, **가상계좌 입금**만 사용할 수 있습니다.

자세한 env 설명은 [ENV-설정-가이드.md](ENV-설정-가이드.md)의 "포트원(KG이니시스) PG" 섹션을 참고하세요.

---

## 8. 테스트 결제 하는 방법

### 8-1. 사전 확인

- **테스트 연동** 채널을 추가했고, `.env`에 `NEXT_PUBLIC_PORTONE_STORE_ID`, `NEXT_PUBLIC_PORTONE_CHANNEL_KEY`가 설정되어 있어야 합니다.
- 개발 서버 실행 중이라면 `.env` 수정 후 한 번 재시작합니다.

### 8-2. 결제까지 진행하는 순서

1. **숙소 상세** 페이지에서 날짜·인원 선택 후 **예약하기** 클릭
2. **예약 확인 및 결제** 페이지(`/booking/confirm`)로 이동
3. 예약자 정보(이름, 이메일, 전화번호) 입력
4. 결제 수단에서 **「카드 · 간편결제 (KG이니시스)」** 선택
5. **「₩(금액) 결제하기」** 버튼 클릭
6. 포트원(KG이니시스) **결제창**이 뜨면, 카드 정보 입력 후 결제 진행

### 8-3. KG이니시스 테스트 연동 시 유의사항

- **실제 카드로 결제**하면 **실제로 1회 결제(출금)** 됩니다.
- 테스트 연동 환경에서는 **매일 23:00~23:50** 사이에 해당 건이 **자동 취소(환불)** 됩니다.
- **국민카드·카카오뱅크** 등 국민카드 계열은 테스트 결제를 지원하지 않습니다. 다른 카드로 테스트하세요.
- 테스트용 **가상 카드번호**를 공개하는 경우 PG사·포트원 문서에 따라 다릅니다.  
  **포트원 관리자 콘솔** 또는 [포트원 헬프센터](https://help.portone.io/) → 결제 연동 / 테스트 연동 메뉴에서 테스트 카드 정보가 있는지 확인해 보세요. 없으면 **실제 본인 카드**(당일 밤 자동 취소됨)로 결제 흐름만 확인하는 방식으로 테스트할 수 있습니다.

### 8-4. 결제 후 확인

- 결제가 성공하면 **예약 완료** 페이지로 이동합니다.
- **마이페이지 → 예약 내역**에서 해당 예약이 **결제완료**로 표시되는지 확인하면 됩니다.

---

## 9. 참고 링크

| 용도 | URL |
|------|-----|
| 포트원 관리자 콘솔 | https://admin.portone.io/ |
| 포트원 헬프센터 (KG이니시스 채널) | https://help.portone.io/content/inicis |
| 포트원 테스트 연동 안내 | https://help.portone.io/category/procedure/payment-integration/test |
| KG이니시스 V2 개발 가이드 | https://developers.portone.io/opi/ko/integration/pg/v2/inicis-v2 |
| KG이니시스 상점관리자 (signkey 등) | https://iniweb.inicis.com/security/login.do |
