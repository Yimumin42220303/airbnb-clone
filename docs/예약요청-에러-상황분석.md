# 예약 요청하기 버튼 클릭 시 "일시적인 오류가 발생했어요" 상황 분석

## 현상

- 게스트가 **예약 확인** 페이지에서 **예약 요청하기** 버튼을 누르면
- 전역 에러 화면(**일시적인 오류가 발생했어요** + **다시 시도**)이 표시됨
- 이 메시지는 `src/app/error.tsx`(에러 바운더리)에서 출력됨 = **어딘가에서 예외가 throw됨**

---

## 가능한 발생 시점

1. **예약 확인 페이지(클라이언트)**  
   - `handleSubmit` → `fetch` → `res.json()` 또는 `router.push()` 등에서 예외  
   - 이 경우엔 같은 폼 위에 `setError(...)` 로 메시지가 뜨는 게 일반적  
   - 그래서 **전역 에러가 뜬다면** 아래 2번 가능성이 더 큼

2. **예약 완료 페이지(서버)** ← **가장 유력**  
   - `예약 요청하기` → API 201 → `router.push(/booking/complete?...)`  
   - 클라이언트가 완료 페이지로 이동 요청  
   - 서버에서 **완료 페이지 RSC 렌더 중** 예외 발생 → 클라이언트가 에러 수신 → 에러 바운더리 표시

즉, **완료 페이지 서버 렌더 단계**에서 throw가 나면 "일시적인 오류가 발생했어요"가 뜹니다.

---

## 완료 페이지에서 예외가 날 수 있는 지점

| 구간 | 내용 | 비고 |
|------|------|------|
| `await searchParams` | searchParams Promise 처리 | 서버리스/엣지에서 이슈 가능성 |
| `decodeURIComponent(params.title)` | 잘못된 인코딩 시 throw | 이미 `safeDecodeTitle()`로 보완 |
| **try 안** | `prisma.booking.findUnique`, `conversation.findUnique`, `redirect()` | DB/네트워크 오류, 또는 **redirect()가 throw** |
| **try 밖 (return JSX)** | `Header`, `Footer`, `BookingStepIndicator` 등 렌더 | 자식 컴포넌트에서 throw 시 그대로 전파 |

특히 **`redirect()`** 는 Next.js에서 **의도적으로 예외를 throw**합니다.  
이 호출이 **try 안**에 있으면, 현재 코드처럼 **catch에서 잡혀서** 리다이렉트가 취소되고, 대신 catch 블록에서 반환하는 "예약 정보를 불러오는 중 오류가 발생했어요" UI가 나올 수 있습니다.  
(실제로는 새 예약은 pending이라 redirect가 호출되지 않지만, 다른 경로에서 redirect를 쓰는 경우 동일 패턴이면 문제가 됨.)

그래서:

- **redirect** 는 catch에서 **다시 throw** 해 주는 것이 안전하고,
- **나머지 예외**는 catch에서 **친절한 UI**로 처리하는 방식이 맞습니다.

---

## 추가로 의심할 수 있는 원인

1. **DB(Prisma)**  
   - 서버리스에서 연결 실패/타임아웃 시 `findUnique` 등에서 throw  
   - 이 경우 **try 안**이면 우리가 catch해서 "예약 정보를 불러오는 중 오류가 발생했어요"로 보여줄 수 있음  
   - try 밖이면 전역 에러로 이어짐

2. **searchParams**  
   - `const params = await searchParams` 가 try 밖에 있으면, 여기서 reject되면 전역 에러  
   - 가능하다면 **전체 로직을 try 안**으로 넣거나, searchParams 실패 시 fallback 처리

3. **자식 컴포넌트**  
   - `BookingStepIndicator`, `Header`, `Footer` 등이 **특정 props/상태에서** throw하면 그대로 에러 바운더리로 전파  
   - 완료 페이지는 `booking`이 있을 때만 StepIndicator에 `status`/`paymentStatus`를 넘기므로, **null/undefined 처리**는 되어 있음.  
   - 다만 **서버/클라이언트 경계**나 **번들** 문제로 예상 못 한 throw가 나올 수는 있음

4. **배포/캐시**  
   - 이전에 수정한 try-catch / safeDecode 가 **아직 배포되지 않았거나**, CDN/브라우저 캐시로 **옛 버전**이 실행 중일 수 있음  
   - 같은 코드인데도 환경에 따라 "예약 정보를 불러오는 중 오류" 대신 전역 에러만 보일 수 있음

---

## 조치 제안 (코드)

1. **redirect() 를 try-catch에서 재throw**  
   - catch 블록 안에서 `redirect` 용 throw인지 판별 후 **그대로 다시 throw**  
   - Next.js에서는 `isRedirectError(error)` 또는 `error.digest === 'NEXT_REDIRECT'` 등으로 판별

2. **완료 페이지 전체를 try-catch로 감싸기**  
   - `await searchParams` 포함해 **페이지 로직 전체**를 try 안에 두고,  
   - catch에서 redirect만 재throw, 나머지는 "예약 정보를 불러오는 중 오류가 발생했어요" + 내 예약 보기 UI

3. **에러 원인 로깅**  
   - catch 시 `console.error` 또는 로깅 서비스에 `error.message`, `error.digest`, 스택 등 기록  
   - Vercel 등 서버 로그로 **실제 원인** 확인 가능

4. **클라이언트 방어**  
   - 이미 적용: API 응답에 `data?.id` 없으면 완료 페이지로 가지 않음  
   - 유지하고, 필요하면 `router.push` 실패 시에도 `setError` 로 폼 안에서 안내

---

## 정리

- **표시되는 메시지**: "일시적인 오류가 발생했어요" = **에러 바운더리가 잡은 예외**가 한 번이라도 발생했다는 뜻.
- **가장 가능성 높은 위치**: **예약 완료 페이지**(`/booking/complete`)가 **서버에서 렌더될 때** 발생하는 예외.
- **우선 적용할 것**:  
  - 완료 페이지 **전체 try-catch** + **redirect 재throw**  
  - **로그 추가**로 실제 throw 원인 확인  
  - 배포 후 캐시 무시하고 재테스트.

이렇게 하면 원인을 좁히면서도, DB/네트워크 등 예기치 않은 오류는 "예약 정보를 불러오는 중 오류가 발생했어요"로 정리해 줄 수 있습니다.

---

## 10. "예약 목록을 불러오는 중 오류가 발생했어요" (내 예약 페이지)

예약 요청 후 `/my-bookings?requested=1`로 이동했을 때 이 메시지가 뜨면, **내 예약 페이지** 서버 렌더 또는 클라이언트 렌더 중에 예외가 난 것입니다.

**가능한 원인**
- **getServerSession** 실패 (서버리스에서 쿠키/세션 처리 이슈)
- **Prisma** 연결 실패·타임아웃 (Vercel 서버리스 DB 연결 한도, cold start)
- **searchParams** 처리 예외
- 예약 데이터에 **listing**이 없거나 **날짜**가 비정상일 때 렌더 단계에서 throw

**조치**
- 내 예약 페이지에 **방어 코드** 추가: `listing` optional chaining, 날짜 유효성 검사, 이미지 없을 때 div 대체.
- **Vercel 대시보드** → 프로젝트 → **Logs** (또는 Deployments → 실패한 배포 → Function Logs)에서 해당 요청 시점의 에러 메시지·스택 확인.
- **환경 변수**: `DATABASE_URL`, `NEXTAUTH_SECRET`, `NEXTAUTH_URL` 등이 배포 환경에 올바르게 설정되어 있는지 확인.
