# 알림 기능 기획 및 요건정의서

**프로젝트**: 도쿄민박 (airbnb-clone)  
**문서 버전**: 1.0  
**작성 목적**: 게스트·호스트 모두에게 시기적절한 알림을 제공하여 이탈 방지, 전환율·만족도 향상

---

## 1. 개요

### 1.1 배경

- 예약 요청·호스트 승인·결제·메시지 등 **핵심 이벤트**가 발생해도 사용자가 해당 페이지에 있지 않으면 인지가 늦어짐.
- 이메일만으로는 오픈률·클릭률 한계가 있으며, **앱 내 알림**이 있으면 재방문·전환에 유리함.
- 호스트는 **새 예약 요청**을 빨리 확인해야 승인/거절 기한(24시간) 내 대응 가능.
- 게스트는 **호스트 승인·결제 안내**를 빨리 보아야 결제 기한(24시간) 내 결제로 이어질 수 있음.

### 1.2 목표

| 목표 | 설명 |
|------|------|
| **발생 시점 인지** | 예약·메시지·결제 관련 이벤트 발생 시 헤더에서 즉시 확인 가능 |
| **행동 유도** | 알림 클릭 시 해당 예약/메시지/결제 화면으로 직행하여 다음 행동(승인, 결제, 답장) 촉진 |
| **역할별 맞춤** | 게스트·호스트 각각에게 의미 있는 이벤트만 노출, 노이즈 최소화 |
| **일관된 UI** | 기존 헤더·디자인 토큰과 조화되는 알림 진입점(벨 아이콘) 및 목록 UX |

### 1.3 범위 (Phase 1)

- **앱 내 알림만** 대상. 푸시 알림(브라우저/모바일 앱)은 별도 단계에서 검토.
- **로그인 사용자**만 알림 대상. 비로그인 사용자에게는 벨 미노출.
- 알림 **생성·조회·읽음 처리·배지**까지. “전체 읽음” 등 부가 기능은 Phase 2에서 검토.

---

## 2. 알림 시나리오 (역할별)

### 2.1 게스트 대상 알림

| # | 알림 유형 | 트리거 | 알림 문구 예시 | 링크(클릭 시 이동) | 우선순위 |
|---|-----------|--------|----------------|---------------------|----------|
| G1 | **호스트 승인** | 호스트가 예약 승인 시 | "호스트가 예약을 승인했어요. 24시간 이내에 결제해 주세요." | `/booking/[id]/pay` 또는 `/messages/[conversationId]` | 최우선 |
| G2 | **호스트 거절** | 호스트가 예약 거절 시 | "호스트가 예약을 거절했어요. 다른 숙소를 찾아보세요." | `/my-bookings` | 높음 |
| G3 | **새 메시지** | 대화방에 새 메시지 수신(시스템/호스트) | "○○ 호스트가 메시지를 보냈어요." 또는 "도쿄민박에서 메시지가 왔어요." | `/messages/[conversationId]` | 높음 |
| G4 | **결제 기한 리마인더** | 승인 후 24시간 임박(선택, Cron) | "결제 기한이 얼마 남지 않았어요. 지금 결제해 주세요." | `/booking/[id]/pay` | 중간 |
| G5 | **예약 확정** | 결제 완료로 예약 확정 시 | "결제가 완료되었어요. 예약이 확정되었습니다." | `/my-bookings` 또는 `/messages/[id]` | 중간 |
| G6 | **리뷰 작성 유도** | 체크아웃일 경과 후 리뷰 미작성(선택) | "○○ 숙소에 다녀오셨나요? 리뷰를 남겨주세요." | `/listing/[id]#review` | 낮음 |

### 2.2 호스트 대상 알림

| # | 알림 유형 | 트리거 | 알림 문구 예시 | 링크(클릭 시 이동) | 우선순위 |
|---|-----------|--------|----------------|---------------------|----------|
| H1 | **새 예약 요청** | 게스트가 예약 요청 제출 시 | "○○님이 ○○ 숙소에 예약을 요청했어요. 24시간 이내에 승인/거절해 주세요." | `/host/bookings` 또는 해당 예약 상세/메시지 | 최우선 |
| H2 | **새 메시지** | 대화방에 새 메시지 수신(게스트) | "○○ 게스트가 메시지를 보냈어요." | `/messages/[conversationId]` | 높음 |
| H3 | **게스트 결제 완료** | 게스트가 결제 완료 시 | "○○님이 결제를 완료했어요. 예약이 확정되었습니다." | `/host/bookings` 또는 해당 예약 | 높음 |
| H4 | **예약 취소** | 게스트 또는 시스템에 의한 예약 취소 시 | "○○ 예약이 취소되었어요." | `/host/bookings` | 중간 |

---

## 3. 기능 요구사항

### 3.1 알림 진입점 (헤더 벨 아이콘)

| ID | 요구사항 | 상세 |
|----|----------|------|
| F-01 | **위치** | 헤더 우측, **프로필(UserMenu) 왼쪽**에 벨 아이콘 배치. 게스트/호스트 모드 공통. 로그인 시에만 표시. |
| F-02 | **비주얼** | 라인(아웃라인) 벨 아이콘, **연한 회색 원형 배경** 위에 진한 회색/검정 벨. 배경색 `#f4f4f5`(pillBg) 또는 `#e5e5e5`(lightGray), 아이콘 `#525252`(gray) 또는 `#1a1a1a`(black). 터치/호버 시 약간 강조. |
| F-03 | **배지** | **안 읽은 알림이 1건 이상**이면 벨 위 우측 상단에 빨간 점 또는 숫자 배지. 99건 초과 시 "99+" 표기. |
| F-04 | **클릭 동작** | 클릭 시 **알림 드롭다운** 또는 **알림 전용 페이지**(`/notifications`)로 이동. Phase 1에서는 **드롭다운** 권장(진입 경로 짧음). |

### 3.2 알림 목록 (드롭다운)

| ID | 요구사항 | 상세 |
|----|----------|------|
| F-05 | **표시 순서** | **최신순**. 생성일시(createdAt) 내림차순. |
| F-06 | **표시 항목** | 각 알림: 아이콘(유형별) + **제목/요약 문구** + **상대 시각**(예: "5분 전", "1시간 전", "어제"). |
| F-07 | **읽음/안 읽음** | 안 읽은 알림은 배경색 또는 좌측 바로 구분. 클릭 시 **해당 알림 읽음 처리** 후 링크로 이동. |
| F-08 | **빈 상태** | 알림이 없을 때: "아직 알림이 없어요." 문구 + (선택) "예약이나 메시지를 확인해 보세요." |
| F-09 | **더 보기** | 드롭다운에 5~10건만 노출 시, "모든 알림 보기" 링크로 `/notifications` 연결. (전체 목록 페이지는 Phase 1 또는 2에서 구현 가능) |

### 3.3 알림 생성(서버)

| ID | 요구사항 | 상세 |
|----|----------|------|
| F-10 | **생성 시점** | 위 시나리오(G1~G6, H1~H4)의 **트리거 이벤트 발생 시** 서버에서 Notification 레코드 생성. 기존 API(예: PATCH 예약 승인, POST 메시지 등) 내부에서 생성 호출. |
| F-11 | **수신자** | 게스트 알림 → 해당 예약의 `userId`(게스트). 호스트 알림 → 해당 숙소의 `listing.userId`(호스트). 메시지 알림 → 대화 상대방. |
| F-12 | **중복 제한** | 동일 유형·동일 예약/대화·짧은 시간(예: 1분) 내 중복 생성 방지. (예: 같은 예약에 "새 메시지" 알림 연속 생성 최소화) |

### 3.4 읽음 처리 및 배지 수

| ID | 요구사항 | 상세 |
|----|----------|------|
| F-13 | **읽음 처리** | 사용자가 알림을 **클릭**했을 때 해당 알림을 `readAt` 기록. |
| F-14 | **배지 수** | **readAt이 null인 알림 개수**를 API로 제공. 헤더 벨은 이 값을 배지에 반영. |

### 3.5 접근성·UX

| ID | 요구사항 | 상세 |
|----|----------|------|
| F-15 | **접근성** | 벨 버튼에 `aria-label="알림"`, 드롭다운 열림 시 `aria-expanded`, 포커스 트랩 등 키보드·스크린리더 대응. |
| F-16 | **외부 클릭** | 드롭다운 열린 상태에서 외부 클릭 시 닫기. |
| F-17 | **반응형** | 모바일에서도 드롭다운이 화면 안에 들어오도록 최대 높이 제한 + 스크롤. |

---

## 4. 비기능 요구사항

| ID | 항목 | 요구사항 |
|----|------|----------|
| NF-01 | **성능** | 알림 목록 API 응답 200ms 이내 목표. 배지 수는 캐시 또는 경량 쿼리로 조회. |
| NF-02 | **일관성** | 기존 디자인 토큰(`design-tokens.ts`, Tailwind `minbak-*`) 사용. |
| NF-03 | **보안** | 본인 알림만 조회/읽음 처리. API에서 `userId` 검증 필수. |

---

## 5. 데이터 모델

### 5.1 Notification 모델 (Prisma)

```prisma
model Notification {
  id        String    @id @default(cuid())
  userId    String    // 수신자
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String    // 예: "booking_approved", "booking_rejected", "new_message", "new_booking_request", "payment_completed", "booking_cancelled" 등
  title     String    // 알림 제목/요약 (예: "호스트가 예약을 승인했어요.")
  linkPath  String?   // 클릭 시 이동 경로 (예: "/booking/xxx/pay", "/messages/yyy")
  linkLabel String?   // 선택: "결제하기" 등 CTA 문구
  // 연관 엔티티 (선택, 알림 그룹화·중복 방지용)
  bookingId     String?
  conversationId String?
  listingId     String?
  readAt        DateTime?  // null = 안 읽음
  createdAt     DateTime   @default(now())

  @@index([userId, createdAt])
  @@index([userId, readAt])
}
```

### 5.2 User 모델 확장

- `User`에 `notifications Notification[]` 관계 추가.

---

## 6. API 명세 (요약)

| 메서드 | 경로 | 설명 |
|--------|------|------|
| GET | `/api/notifications` | 목록 조회. 쿼리: `?limit=20&cursor=...` (최신순). 본인 것만. |
| GET | `/api/notifications/unread-count` | 안 읽은 개수만 반환. 배지용. |
| PATCH | `/api/notifications/[id]/read` | 해당 알림 읽음 처리. 본인 것만. |
| POST | (내부) | 알림 생성은 기존 API 내부에서 `createNotification(...)` 유틸 호출. |

---

## 7. 화면/컴포넌트 구성

| 구분 | 경로/위치 | 비고 |
|------|-----------|------|
| 벨 아이콘 + 배지 | `Header` 내, `UserMenu` 왼쪽 | 클라이언트 컴포넌트. 배지 수는 `/api/notifications/unread-count` 주기적 폴링 또는 SWR 등. |
| 알림 드롭다운 | 벨 클릭 시 Header 하단 | 최근 10건 + "모든 알림 보기" 링크. 클릭 시 읽음 처리 + `router.push(linkPath)`. |
| (선택) 전체 알림 페이지 | `/notifications` | Phase 2에서 페이지네이션·필터 구현 가능. |

---

## 8. 알림 유형 코드 및 생성 시점 매핑

| type (코드) | 수신자 | 생성 시점 (기존 코드 위치) |
|-------------|--------|----------------------------|
| `booking_approved` | 게스트 | `PATCH /api/host/bookings/[id]` (status: confirmed) |
| `booking_rejected` | 게스트 | `PATCH /api/host/bookings/[id]` (status: cancelled, reject) |
| `new_message` | 게스트/호스트 | `POST /api/conversations/[id]/messages` (발신자 제외 수신자) |
| `new_booking_request` | 호스트 | `POST /api/bookings` (예약 생성 시, listing.userId) |
| `guest_payment_completed` | 호스트 | `POST /api/payments/verify` 결제 검증 성공 후 |
| `booking_cancelled` | 호스트 | 예약 취소 API (게스트 취소 또는 환불 처리 시) |
| `payment_reminder` | 게스트 | Cron 또는 예약 승인 후 24h 근접 시 (선택) |
| `review_request` | 게스트 | Cron 체크아웃 지난 예약 + 리뷰 미작성 (선택) |

---

## 9. 구현 우선순위 (Phase 1 권장)

| 순서 | 항목 | 설명 |
|------|------|------|
| 1 | DB 스키마 | `Notification` 모델 추가, 마이그레이션 |
| 2 | 알림 생성 유틸 | `createNotification(userId, type, title, linkPath, ...)` 및 기존 API 연동 (H1, G1, G2, G3, H2, H3) |
| 3 | API | `GET /api/notifications`, `GET /api/notifications/unread-count`, `PATCH /api/notifications/[id]/read` |
| 4 | 헤더 벨 + 배지 | 벨 아이콘(라인, 원형 배경), unread-count 반영 배지 |
| 5 | 알림 드롭다운 | 최근 N건 표시, 클릭 시 읽음 + 이동, 빈 상태 문구 |
| 6 | (선택) 전체 알림 페이지 | `/notifications` 목록 + 페이지네이션 |

---

## 10. 요약

- **게스트**: 호스트 승인·거절·새 메시지·결제 리마인더·예약 확정·리뷰 유도 등 알림으로 다음 행동(결제, 메시지 확인) 유도.
- **호스트**: 새 예약 요청·새 메시지·게스트 결제 완료·예약 취소 등 알림으로 24시간 내 대응 촉진.
- **UI**: 헤더에 연한 원형 배경의 라인 벨 아이콘 + 안 읽은 개수 배지, 클릭 시 드롭다운으로 최근 알림 표시 및 클릭 시 해당 화면으로 이동.
- **기술**: Prisma `Notification` 모델, 기존 이벤트 발생 지점에서 알림 생성, 경량 API로 목록/배지/읽음 처리 제공.

이 요건정의서를 기준으로 DB 스키마·API·헤더 컴포넌트 순으로 구현하면 됩니다.
