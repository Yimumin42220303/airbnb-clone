# 호스트 매출 상황 및 정산 프로세스 고도화 기획

## 1. 현황 요약

### 1.1 현재 구현된 기능
- **매출 페이지** (`/host/revenue`)
  - 결제 완료·미취소 예약 기준 **총 매출**(누적)
  - **이번 달 매출**: 체크인 기준 당월 합계
  - **숙소별 매출**: 숙소별 합계·건수
  - **최근 결제 건**: 최근 10건 목록 (숙소명, 체크인일, 금액)
- **데이터**
  - `Booking`: `totalPrice`, `paymentStatus`, `checkIn` 등
  - `PaymentTransaction`: 포트원 결제 이력 (결제·환불 등)
  - **정산(payout) 개념 없음**: “매출 = 게스트 결제액”만 표시, 수수료·실수령·지급 주기 미구현

### 1.2 개선 방향
1. **매출 상황**: 기간·필터·내역·다운로드 등으로 가독성·신뢰성 강화  
2. **정산 프로세스**: “매출 → 수수료 차감 → 정산 대상 → 지급” 단계를 정의하고, 단계별 데이터·UI 설계

---

## 2. 매출 상황 고도화

### 2.1 목표
- 호스트가 **언제, 어떤 예약에서, 얼마가 발생했는지** 한눈에 파악
- **기간 선택·숙소 필터·내역 다운로드**로 운영·세금·정산 검증에 활용 가능하도록

### 2.2 기능 제안

| 구분 | 내용 | 우선순위 |
|------|------|----------|
| **기간 필터** | 오늘/이번 주/이번 달/지난 달/기간 직접 선택(시작일~종료일) | 높음 |
| **기준 일자** | “체크인 기준” / “결제일 기준” 토글 (현재는 체크인만) | 중간 |
| **숙소 필터** | 전체 / 특정 숙소만 선택해 해당 숙소 매출만 표시 | 높음 |
| **요약 카드** | 선택 기간의 총 매출, 건수, (도입 시) 수수료 차감 후 정산 대상액 | 높음 |
| **매출 내역 테이블** | 예약 ID, 숙소명, 체크인/체크아웃, 결제일, 게스트 결제액, (선택) 수수료·호스트 수령액, 상태 | 높음 |
| **페이지네이션/더보기** | 최근 10건 → 기간/필터에 따른 전체 내역 페이지네이션 또는 “더보기” | 중간 |
| **CSV/엑셀 다운로드** | 선택 기간·필터에 따른 매출 내역 다운로드 (세금·정산 검증용) | 중간 |
| **간단 그래프** | 월별 매출 추이(막대/꺾은선) — 선택 사항 | 낮음 |

### 2.3 데이터·API
- **기존**: `GET /api/host/revenue` 또는 페이지 내 `paidBookings` 등으로 결제 완료 예약 조회
- **추가 제안**
  - 쿼리 파라미터: `startDate`, `endDate`, `listingId`(선택), `basis=checkin|payment`
  - 결제일은 `PaymentTransaction.verifiedAt` 또는 `Booking.updatedAt` 등에서 취득
  - 필요 시 `PaymentTransaction`과 조인해 “결제 확정일” 기준 제공

### 2.4 UI 배치 제안
- 상단: 기간 선택(버튼/날짜 피커) + 숙소 필터(드롭다운) + (선택) 기준 일자 토글
- 그 아래: 요약 카드 2~3개 (총 매출, 건수, 정산 대상 등)
- 이어서: 숙소별 요약(기존 유지) + **매출 내역 테이블** + “내역 다운로드” 버튼

---

## 3. 정산 프로세스 설계

### 3.1 개념 정의
- **매출(Revenue)**: 게스트가 결제한 금액 (현재 `Booking.totalPrice` 기준)
- **플랫폼 수수료**(선택): 매출의 N% 또는 건당 고정액 등
- **정산 대상액**: 매출 − 플랫폼 수수료 − (환불·조정 등)
- **정산(Payout)**: 정산 대상액을 호스트에게 실제 지급하는 행위 및 그 주기(예: 월 1회)

### 3.2 정산 주기 옵션 (기획 선택)
| 옵션 | 설명 | 구현 난이도 |
|------|------|-------------|
| A. 월 1회 정산 | 매월 말일(또는 익월 N일)에 전월 분을 한 번에 지급 | 중 |
| B. N일 후 정산 | 체크아웃 후 N일 경과분을 주기적으로 지급 | 중 |
| C. 수동 정산 | 관리자가 “이번 분 정산하기” 버튼으로 지급 실행 | 상대적으로 낮음 |

실제 지급은 **계좌 이체·페이팔·토스 등** 외부 연동이 필요하므로, **1단계**에서는 “정산 대상 금액·내역까지 DB/UI로 관리”하고, “실제 송금”은 수동(오프라인)으로 진행하는 방식이 현실적입니다.

### 3.3 데이터 모델 제안

#### 3.3.1 호스트 정산 주기/설정 (선택)
```
HostPayoutSetting (또는 User 테이블 확장)
- userId
- payoutCycle: "monthly" | "biweekly" | "manual"
- payoutDayOfMonth: 1..28 (월 정산 시)
- bankAccountSnapshot: JSON 또는 별도 테이블 (은행명, 계좌번호 마스킹 등)
```
→ 초기에는 테이블 없이 “고정 규칙(예: 매월 10일 정산)”만 적용해도 가능.

#### 3.3.2 정산 런(Payout Run) — 권장
한 번의 “정산 실행” 단위를 기록해, “어떤 기간 매출을 언제 정산했는지” 추적.

```
PayoutRun
- id
- userId (호스트)
- periodStart, periodEnd (정산 대상 기간, 체크인 또는 결제일 기준)
- totalRevenue (해당 기간 매출 합계)
- platformFee (플랫폼 수수료)
- payoutAmount (실지급 대상액)
- status: "pending" | "approved" | "paid" | "cancelled"
- paidAt (실제 지급 처리 일시, 수동 입력 가능)
- memo (관리자 메모)
- createdAt, updatedAt
```

#### 3.3.3 정산 상세(선택)
정산 런에 “어떤 예약들이 포함되었는지” 연결.

```
PayoutRunItem
- id
- payoutRunId
- bookingId
- revenue (해당 예약 매출)
- platformFee
- hostAmount
```
→ 나중에 “이번 정산에 포함된 예약 목록” 상세 보기·다운로드용.

### 3.4 수수료 정책 (예시)
- 플랫폼 수수료: 매출의 10% (또는 0%로 시작 후 추후 적용)
- 환불 건: 이미 정산에 포함했다면 “다음 정산에서 차감” 또는 “별도 회수” 규칙 필요  
→ 1단계에서는 **수수료 0%**로 두고, “정산 대상액 = 매출”로 두면 구현이 단순합니다.

### 3.5 호스트 UI 제안 (정산 관련)

| 화면/요소 | 내용 |
|-----------|------|
| **매출 페이지 내 “정산” 섹션** | “다음 정산 예정”: 예정 금액·예정일(또는 “이번 달 정산 예정액”) |
| **정산 내역** | 과거 정산 런 목록: 기간, 정산 대상액, 상태(예정/완료), (관리자만) paidAt |
| **정산 상세** | 한 건 클릭 시 해당 기간 매출·수수료·지급액, 포함 예약 목록(테이블/다운로드) |

### 3.6 관리자(운영자) 기능
- **정산 실행**: “2025년 1월분 정산 생성” → 해당 호스트별로 `PayoutRun` 생성, status=pending
- **정산 승인/지급 처리**: status를 paid로 변경, paidAt 기록 (실제 송금 후 수동 입력 가능)
- **호스트별 정산 목록**: 호스트별·기간별 PayoutRun 조회·필터

---

## 4. 구현 단계 제안

### Phase 1 — 매출 상황만 고도화 (정산 로직 없음)
- 기간 필터(시작일/종료일), 숙소 필터
- 매출 내역 테이블(페이지네이션), CSV 다운로드
- “결제일 기준” 옵션 (데이터 있으면)

**산출물**: 매출 페이지 개선, API 확장(쿼리 파라미터)

### Phase 2 — 정산 “보기”까지
- `PayoutRun` 테이블 추가 (수수료 0% 가정)
- 관리자: “월별 정산 런 생성” (해당 월 결제 완료 예약 합계로 PayoutRun 1건 생성)
- 호스트: 매출 페이지에 “정산 내역” 블록 — 과거 PayoutRun 목록·금액·상태

**산출물**: 정산 개념 도입, 호스트는 “언제 얼마가 정산됐는지” 확인 가능

### Phase 3 — 정산 프로세스 완성
- `PayoutRunItem` (선택), 정산 상세 화면
- “다음 정산 예정” 표시 (규칙에 따른 예정 금액·일자)
- 관리자: 승인/지급 처리(paidAt), 메모

**산출물**: 정산 단위·이력·상세까지 완료

### Phase 4 (선택) — 수수료·자동화
- 플랫폼 수수료 % 또는 고정액 설정, 자동 계산
- Cron으로 “매월 N일 자동 PayoutRun 생성” 등

---

## 5. 정리

| 구분 | 요약 |
|------|------|
| **매출 고도화** | 기간·숙소 필터, 매출 내역 테이블, 다운로드, (선택) 결제일 기준·간단 그래프 |
| **정산 프로세스** | PayoutRun(정산 런) 도입 → 호스트 정산 이력·예정 표시, 관리자 정산 생성/지급 처리 |
| **우선 적용** | Phase 1으로 매출 페이지만 먼저 개선한 뒤, Phase 2에서 정산 테이블·목록 노출 |

이 기획을 기준으로 Phase 1부터 순차 적용하면, 호스트 매출 가시성과 정산 프로세스를 단계적으로 고도화할 수 있습니다.  
수수료율·정산 주기·실제 지급 채널(은행 API 등)은 운영 정책에 맞춰 본 기획안을 보완하면 됩니다.
