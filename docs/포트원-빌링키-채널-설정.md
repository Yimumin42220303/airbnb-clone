# 포트원 빌링키(정기결제) 채널 설정 가이드

체크인 7일 이상 전 예약 시 카드 등록 후 자동 결제를 사용하려면, **일반/정기결제** 모듈로 채널을 추가해야 합니다.

---

## 1. 채널 유형 정리

| 결제 모듈 | 지원 기능 |
|-----------|-----------|
| **결제창** | 일회성 결제만 (현재 사용 중인 채널) |
| **일반/정기결제** | 일회성 + 빌링키(정기결제) 둘 다 가능 |

→ 빌링키를 쓰려면 **"일반/정기결제"** 모듈로 채널을 새로 만들어야 합니다.

---

## 2. 포트원 콘솔에서 채널 추가

### 2-1. 접속
1. https://admin.portone.io 접속 후 로그인
2. 왼쪽 메뉴 **결제 연동** → **연동 관리** 클릭

### 2-2. 채널 추가
1. **채널 추가** 버튼 클릭
2. **채널 이름**: 예) `도쿄민박 정기결제` (구분용 별칭)
3. **채널 속성**: `결제` 선택
4. **결제 모듈**: **"결제창 일반/정기결제"** 또는 **"API 일반/정기결제 V2"** 선택
   - 여기서 "일반/정기결제"가 포함된 모듈을 선택해야 빌링키가 동작합니다.
   - "결제창"만 있는 모듈은 일회성 결제만 지원합니다.
5. **PG Provider**: `inicis_v2` (KG이니시스)
6. **PG상점아이디 (MID)**: KG이니시스에서 발급받은 MID 입력
   - 기존 일반결제 채널과 같은 MID를 쓸 수 있는지 KG이니시스에 문의
   - 정기결제용 별도 MID가 필요할 수 있음
7. **저장** 클릭

### 2-3. Channel Key 복사
1. 생성된 채널 카드에서 **Channel Key** 복사
2. 형식: `channel-key-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

---

## 3. 환경변수 설정

### 3-1. Vercel (배포 환경)
1. Vercel 대시보드 → 프로젝트 선택 → **Settings** → **Environment Variables**
2. 아래 변수 추가:

| Key | Value | 비고 |
|-----|-------|------|
| `NEXT_PUBLIC_PORTONE_BILLING_CHANNEL_KEY` | 위에서 복사한 Channel Key | Production, Preview, Development 모두 체크 |

### 3-2. 채널 사용 방식

**방법 A: 기존 채널 + 빌링키 채널 분리 (권장)**  
- `NEXT_PUBLIC_PORTONE_CHANNEL_KEY`: 기존 일반결제 채널 (그대로 유지)  
- `NEXT_PUBLIC_PORTONE_BILLING_CHANNEL_KEY`: 새로 만든 일반/정기결제 채널  

→ 7일 미만 예약: 기존 채널로 즉시결제  
→ 7일 이상 예약: 빌링키 채널로 카드 등록

**방법 B: 하나의 채널로 통합**  
- 새로 만든 "일반/정기결제" 채널이 일회성+빌링키 둘 다 지원  
- `NEXT_PUBLIC_PORTONE_CHANNEL_KEY`와 `NEXT_PUBLIC_PORTONE_BILLING_CHANNEL_KEY`를 **같은 값**으로 설정  
- 기존 일반결제 채널은 더 이상 사용하지 않음

### 3-3. 로컬 개발 (.env)
```env
NEXT_PUBLIC_PORTONE_BILLING_CHANNEL_KEY="channel-key-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

---

## 4. 재배포

Vercel에서 환경변수 추가 후 **Redeploy** 실행:
- Deployments 탭 → 최신 배포의 ⋮ 메뉴 → **Redeploy**

---

## 5. MID 관련 참고 (중요)

### 테스트 환경
- **INIpayTest**: 일반결제(일회성) 전용 — **빌링키 미지원**
- **INIBillTst**: 정기결제(빌링키) 테스트 전용

현재 채널이 INIpayTest를 사용 중이면 빌링키 발급이 실패합니다.  
포트원 콘솔 → **결제 연동** → **테스트 연동 관리** → KG이니시스 → **"정기결제 테스트 INIBillTst 설정"** 선택 후 채널을 추가하세요.

### 실거래 환경
KG이니시스 정기결제는 **별도 신청**이 필요할 수 있습니다.
- KG이니시스 관리자: https://admin.inicis.com
- 정기결제(빌링) 상품 신청 여부 확인
- 필요 시 포트원 고객센터 문의
