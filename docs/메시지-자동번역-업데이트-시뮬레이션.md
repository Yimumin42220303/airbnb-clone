# 메시지 자동 번역 업데이트 적용 시뮬레이션

**대상**: 게스트(한→일)·호스트(일→한) 자동 번역 + ON/OFF 설정  
**목적**: 해당 업데이트가 기존 기능·API·클라이언트에 부작용 없이 적용되는지 검증

---

## 1. 변경 영향 범위

| 구분 | 변경 내용 | 영향 받는 코드 |
|------|-----------|----------------|
| DB | `User.autoTranslateEnabled`, `TranslationCache` | Prisma 클라이언트, 마이그레이션 |
| GET /api/me | 응답에 `autoTranslateEnabled` 추가 | 호출처 |
| PATCH /api/account | 요청 body에 `autoTranslateEnabled` 선택 수용 | 호출처 |
| GET /api/conversations/[id]/messages | 응답 메시지에 `bodyDisplay` 추가 | 메시지창 |
| 메시지 페이지 | 초기 메시지에 `bodyDisplay` 계산 후 전달 | MessageThread |
| MessageThread | 표시 시 `bodyDisplay ?? body` 사용 | - |
| 마이페이지 | 계정관리 탭에 자동 번역 토글 추가 | - |

---

## 2. 호출처별 호환성

### 2.1 GET /api/me

| 호출처 | 사용 필드 | 시뮬레이션 결과 |
|--------|-----------|-----------------|
| **BookingPayContent.tsx** | `name`, `email`, `phone` 만 사용 | ✅ `autoTranslateEnabled` 추가는 무시해도 됨. 기존 동작 유지. |
| 기타 | - | ✅ 추가 필드는 선택적이므로 미사용 클라이언트에 영향 없음. |

### 2.2 PATCH /api/account

| 호출처 | 전송 body | 시뮬레이션 결과 |
|--------|-----------|-----------------|
| **ProfileEditForm.tsx** (마이페이지 수정) | `name`, `phone`, `image` 만 전송 | ✅ `autoTranslateEnabled` 미포함 시 기존처럼 해당 필드만 업데이트. `data`에 없는 필드는 변경 안 함 → **자동 번역 설정 유지**. |
| **MypageContent AccountSection** | `{ autoTranslateEnabled: true/false }` 단독 전송 | ✅ 서버에서 `typeof autoTranslateEnabled === "boolean"` 일 때만 `data`에 넣음. `Object.keys(data).length > 0` 만족 → 400 아님. |

### 2.3 GET /api/conversations/[id]/messages

| 소비처 | 사용 필드 | 시뮬레이션 결과 |
|--------|-----------|-----------------|
| **MessageThread.tsx** | `id`, `body`, `createdAt`, `senderId`, `isFromMe`, `senderName`, **(신규)** `bodyDisplay` | ✅ 모든 메시지에 `bodyDisplay` 포함해 반환(번역 안 하면 `bodyDisplay: m.body`). 표시는 `m.bodyDisplay ?? m.body` → 필드 없어도 원문 표시. |
| **승인 메시지 판별** | `isApprovalMessage(m.isFromMe, m.body)` | ✅ **원문 `m.body`** 기준으로만 판별하므로, 번역문이 들어가도 “결제하기” 버튼 노출 로직 변경 없음. |

### 2.4 대화 목록 API (GET /api/conversations)

| 항목 | 시뮬레이션 결과 |
|------|-----------------|
| **lastMessage.body** | ✅ 변경 없음. 마지막 메시지 원문만 반환. `bodyDisplay` 미사용. |

---

## 3. 엣지 케이스

| 시나리오 | 동작 | 결과 |
|----------|------|------|
| **DEEPL_AUTH_KEY 미설정** | `translateMessageBody`에서 API 호출 생략, 원문 반환 | ✅ 오류 없이 원문만 표시. |
| **DeepL API 오류/타임아웃** | `try/catch` 후 원문 반환 | ✅ 표시 깨짐 없음. |
| **자동 번역 OFF** | `autoTranslate === false` → 모든 메시지에 `bodyDisplay: m.body` | ✅ 항상 원문만 표시. |
| **내가 보낸 메시지** | `m.senderId === userId` → 번역 스킵, `bodyDisplay: m.body` | ✅ 원문만 표시. |
| **메시지 삭제** | `TranslationCache`는 `Message`에 `onDelete: Cascade` | ✅ 메시지 삭제 시 캐시도 함께 삭제. |
| **마이페이지 첫 로드** | `user.autoTranslateEnabled`가 기존 유저는 `false`(기본값) | ✅ 체크박스 OFF로 표시. |

---

## 4. 성능·순서

| 항목 | 내용 | 판단 |
|------|------|------|
| **메시지 목록 첫 로드** | 상대방 메시지 N건당 번역 1회(캐시 미스 시). DeepL 호출 N회 가능 | ⚠️ 대화가 매우 길면 첫 로드 지연 가능. 캐시 적중 시 이후는 빠름. 필요 시 limit 유지(50건)로 상한 있음. |
| **폴링** | 6초마다 GET messages → 이미 캐시된 번역은 DB 조회만 | ✅ 캐시 Hit 시 API 호출 없음. |
| **메시지 페이지 SSR** | `initialMessages`에 대해 번역 적용(캐시 활용) | ✅ 캐시 있으면 DB만, 없으면 DeepL 1회 후 캐시 저장. |

---

## 5. 스키마·타입

| 항목 | 확인 |
|------|------|
| **Prisma** | `User.autoTranslateEnabled` 기본값 `false`. `TranslationCache`는 `Message`와 1:N, Cascade 삭제. | ✅ |
| **Message 타입 (MessageThread)** | `bodyDisplay?: string` 선택 필드. API는 항상 `bodyDisplay` 포함. | ✅ 옵셔널이라 기존 호출도 안전. |
| **UserData (MypageContent)** | `autoTranslateEnabled?: boolean` 추가. | ✅ |

---

## 6. 결론

| 구분 | 결과 |
|------|------|
| **기존 API 소비처** | GET /api/me, PATCH /api/account, 대화 목록 API 모두 추가 필드만 있거나 선택 처리되어 **호환성 유지**. |
| **메시지 표시** | `bodyDisplay ?? body`로 **bodyDisplay 없을 때도 원문 표시** 보장. |
| **설정 유지** | 프로필 수정 시 `autoTranslateEnabled`를 보내지 않아도 **기존 값 유지**. |
| **번역 실패/미설정** | **원문 폴백**으로 동작. |
| **DB** | Cascade로 **고아 캐시 없음**. |

**종합**: 다른 기능을 깨뜨리지 않고 **스무스하게 적용 가능**한 구조로 되어 있음.  
유일한 주의점은 **대화가 매우 길고 캐시가 비어 있을 때** 첫 로드 시 번역 API 호출로 인한 지연 가능성이 있는 것이며, 현재도 `limit`(50건)으로 상한이 있어 수용 가능한 수준으로 판단됨.
