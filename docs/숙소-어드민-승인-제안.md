# 숙소 어드민 승인 후 게재 – 구현 제안

호스트가 숙소를 등록해도 **어드민이 승인하기 전까지는 검색·상세 노출되지 않도록** 하는 방안입니다.

---

## 1. 현재 구조 요약

- **Listing** 모델에 게재 상태(status) 필드 없음 → 등록 즉시 모두 노출됨.
- **getListings()**: 홈/검색용, 상태 필터 없음.
- **getListingById()**: 상세/예약 확인용, 상태 필터 없음.
- **createListing()**: 등록 시 상태 설정 없음.
- **어드민 숙소 목록**: 전체 목록만 표시, 승인/거절 기능 없음.

---

## 2. 제안: `status` 필드로 승인 흐름 도입

### 2.1 DB 스키마 (Prisma)

`Listing` 모델에 다음 필드 추가:

```prisma
// prisma/schema.prisma - Listing 모델에 추가
/// 게재 상태: "pending"(승인대기) | "approved"(게재) | "rejected"(거절)
status        String   @default("pending")
/// 승인/거절 시각 (선택, 이력용)
approvedAt    DateTime?
rejectedAt    DateTime?
/// 거절 사유 (선택, 호스트 피드백용)
rejectedReason String?
```

- **pending**: 호스트가 등록한 직후 기본값.
- **approved**: 어드민이 승인한 경우에만 검색·상세에 노출.
- **rejected**: 거절 시 노출 안 함. (필요 시 사유 저장)

### 2.2 등록 시 동작

- **createListing()**  
  - 새 숙소 생성 시 `status: "pending"` 으로 저장.  
  - (선택) 요청한 사용자가 `role === "admin"` 이면 `status: "approved"` 로 생성해, 어드민이 등록한 숙소는 바로 게재되게 할 수 있음.

### 2.3 “게재 완료”의 정의

- **검색/홈**: `getListings()` 에 `where: { status: "approved" }` 추가 → 승인된 숙소만 노출.
- **상세/예약**:  
  - 게스트가 보는 상세·예약 확인은 **승인된 숙소만** 보이게.
  - `getListingById()` 를 “공개용”과 “호스트/어드민용”으로 나누는 방식이 단순합니다.
    - **공개용** (검색 결과 클릭, 예약 플로우):  
      `where: { id, status: "approved" }` 인 조회 하나 추가 (예: `getListingByIdForPublic(id)`)  
      → 상세 API·상세 페이지·예약 확인 페이지는 이 함수 사용.
    - **호스트 수정용**: 기존처럼 `getListingByIdForEdit(id)` 로 본인 숙소만 조회 (status 무관).
    - **어드민**: 기존처럼 전체 목록/상세는 Prisma로 직접 조회 (status 무관).

정리하면:

- **등록 완료** = DB에 `status: "pending"` 으로 한 건 생성.
- **게재 완료** = 어드민이 승인해 `status: "approved"` 로 바뀐 뒤, 검색·상세에만 노출.

### 2.4 호스트 화면 (내 숙소 목록)

- `/host/listings` / `GET /api/host/listings`  
  - 본인 숙소 전부 조회 (status 무관).
  - 각 숙소에 **상태 뱃지** 표시:
    - 승인대기(pending) / 게재(approved) / 거절(rejected).
  - 거절된 경우 `rejectedReason` 이 있으면 툴팁/문구로 표시 (선택).

### 2.5 어드민 화면

- **숙소 목록** (`/admin/listings`):
  - 모든 숙소를 status 포함해 표시.
  - **승인대기** 항목에만:
    - [승인] 버튼 → `status: "approved"`, `approvedAt: now()` (선택) 저장.
    - [거절] 버튼 → `status: "rejected"`, `rejectedAt: now()`, `rejectedReason` (선택) 저장.
  - 이미 승인/거절된 항목은 상태만 표시 (필요 시 “승인 취소” 등 추가 가능).

- **API**  
  - 예: `PATCH /api/admin/listings/[id]` body `{ status: "approved" | "rejected", rejectedReason?: string }`  
  - 또는 전용 라우트 `POST /api/admin/listings/[id]/approve`, `POST /api/admin/listings/[id]/reject` 도 가능.

### 2.6 알림 (선택)

- 어드민이 **승인** 시 → 해당 숙소 호스트에게 알림 (예: `type: "listing_approved"`).
- **거절** 시 → 호스트에게 알림 + `rejectedReason` 전달 (예: `type: "listing_rejected"`).

---

## 3. 마이그레이션 적용 (필수)

코드 반영 후 **반드시** DB에 새 컬럼을 적용해야 합니다.

```bash
# 방법 1: 마이그레이션 이력 사용 (권장)
npx prisma migrate deploy

# 방법 2: 스키마만 동기화 (이력 없이)
npx prisma db push
```

- PostgreSQL 사용 시: `prisma/migrations/20260216000000_listing_status_approval/migration.sql` 내용을 직접 실행해도 됩니다.
- 기존 숙소는 마이그레이션에서 `status = 'approved'` 로 한 번에 설정됩니다.

## 4. 구현 체크리스트

| 단계 | 작업 |
|------|------|
| 1 | `Listing` 에 `status`, `approvedAt`, `rejectedAt`, `rejectedReason` 추가 후 마이그레이션 |
| 2 | `createListing()` 에서 `status: "pending"` 설정 (admin 생성 시 `approved` 옵션은 선택) |
| 3 | `getListings()` 에 `where: { status: "approved" }` 추가 |
| 4 | 공개용 상세 조회 추가 (예: `getListingByIdForPublic(id)`) → 상세 API·상세 페이지·예약 확인에서 사용 |
| 5 | 호스트 목록 API/페이지에 `status` 포함, UI에 상태 뱃지 표시 |
| 6 | 어드민 숙소 목록에 승인/거절 버튼 + API 구현 |
| 7 | (선택) 승인/거절 시 호스트 알림 |

---

## 5. 주의사항

- **기존 데이터**: 마이그레이션 시 기존 `Listing` 행은 `status` 가 없으므로 기본값 `"pending"` 이 들어가면 기존 숙소가 한 번에 비공개가 됩니다.  
  → 마이그레이션 스크립트에서 **기존 레코드는 `status = 'approved'`** 로 한 번에 넣어 두는 것을 권장합니다.
- **예약**: 승인 전 숙소는 상세가 안 보이므로 게스트가 예약할 수 없음.  
  승인 전에 호스트가 “테스트 예약”을 넣을 수 있게 할지는 정책 결정 후, 필요하면 호스트/어드민만 예약 가능하도록 별도 분기할 수 있습니다.

이 순서대로 적용하면 “호스트가 등록 → 어드민이 승인 → 그때부터만 등록 및 게재가 완료”되는 흐름을 만들 수 있습니다.
