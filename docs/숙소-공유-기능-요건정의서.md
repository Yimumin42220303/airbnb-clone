# 숙소를 친구에게 공유하기 — 요건정의서

## 1. 개요

### 1.1 목적
게스트가 관심 있는 숙소 링크를 친구·가족에게 쉽게 공유할 수 있도록 하여, 입소문 확산과 예약 전환을 돕는다. (에어비앤비의 “숙소 공유” 기능을 참고)

### 1.2 참조
- **에어비앤비**: 숙소 상세 상단 **Share** 아이콘 → 공유 시트/모달에서 “링크 복사”, “앱으로 공유”, “메시지/메일” 등 제공.
- **공유 링크**: `https://www.airbnb.com/rooms/[listing-id]` 형태의 고정 URL 제공.

### 1.3 범위
| 포함 | 제외(추후 검토) |
|------|------------------|
| 숙소 상세 페이지(`/listing/[id]`)에서 공유 버튼 노출 | 호스트용 “내 숙소 공유” 커스텀 링크 |
| 링크 복사, Web Share API(모바일), 선택적 채널(카카오톡 등) | SNS 공유 시 리치 카드용 전용 이미지 생성 |
| 공유 시트/모달 UI | 공유 횟수·전환 분석(UTM 등) |

---

## 2. 사용자 스토리

| ID | 스토리 | 인수 조건 |
|----|--------|------------|
| US-1 | **게스트**는 숙소 상세에서 “공유” 버튼을 눌러 **링크를 복사**할 수 있다. | 버튼 클릭 시 현재 페이지 URL이 클립보드에 복사되고, “링크가 복사되었습니다” 등 피드백이 표시된다. |
| US-2 | **게스트(모바일)**는 “공유” 버튼을 눌러 **기기 기본 공유 시트**로 공유할 수 있다. | Web Share API 지원 시 네이티브 공유 시트가 뜨고, 링크·제목(숙소명)이 전달된다. |
| US-3 | **게스트**는 공유 시트에서 **카카오톡** 등 지정 채널로 빠르게 공유할 수 있다(선택). | 카카오톡 공유 시 채팅/대화방 선택 후 링크가 공유된다. |
| US-4 | **친구**는 공유받은 링크를 열어 **동일한 숙소 상세 페이지**를 본다. | 쿼리 유지 시: `checkIn`, `checkOut`, `adults`, `children` 등이 있으면 예약 폼에 반영된다. |

---

## 3. 기능 요건

### 3.1 공유 버튼 위치·표시
- **위치**: 숙소 상세 페이지 상단, 제목 오른쪽 영역. (찜 버튼과 같은 줄 또는 그 옆.)
- **표시**: 아이콘 + “공유” 텍스트 또는 아이콘만. (에어비앤비는 상단 우측 Share 아이콘.)
- **반응형**: 모바일에서도 터치하기 쉬운 크기(최소 44px 터치 영역 권장).

### 3.2 공유 대상 URL
- **기본 URL**: `{NEXT_PUBLIC_APP_URL}/listing/{listingId}`  
  (예: `https://tokyominbak.net/listing/abc123`)
- **선택 보존**: 현재 페이지에 `checkIn`, `checkOut`, `adults`, `children` 쿼리가 있으면 공유 URL에 포함해도 됨.  
  (친구가 링크를 열었을 때 같은 일정·인원으로 예약 폼이 채워지도록)

### 3.3 공유 방식

| 방식 | 필수 여부 | 설명 |
|------|-----------|------|
| **링크 복사** | 필수 | “링크 복사” 클릭 시 `navigator.clipboard.writeText(url)`로 URL 복사. 복사 완료 시 토스트/스낵바로 “링크가 복사되었습니다” 표시. |
| **Web Share API** | 필수(모바일) | `navigator.share({ title, url, text })` 지원 시 “공유하기” 등으로 네이티브 시트 호출. 미지원(데스크톱 등) 시 링크 복사로 대체. |
| **카카오톡** | 선택 | 카카오 공유 링크 형태(`https://story.kakao.com/share?url=...`) 또는 기본 공유 시트에 포함되는 방식. (프로젝트에 이미 KakaoIcon 사용 중이면 UI 일관성 유지.) |

### 3.4 공유 시트/모달
- **트리거**: “공유” 버튼 클릭 시 공유 옵션을 담은 시트(모바일) 또는 작은 모달(데스크톱) 표시.
- **항목 예시**  
  - 링크 복사  
  - 공유하기(Web Share API — 지원 시만 표시)  
  - 카카오톡 공유(선택 구현 시)
- **공유 데이터**  
  - **title**: 숙소명(`listing.title`)  
  - **url**: 위 3.2의 URL  
  - **text**: 한 줄 소개(예: “{숙소명} · {위치} · 1박 ₩{가격}” 또는 `description` 앞 100자)

### 3.5 피드백
- 링크 복사 성공: “링크가 복사되었습니다” 토스트/스낵바 (2~3초 후 자동 숨김).
- 복사 실패(권한 등): “복사에 실패했습니다. 주소창에서 URL을 복사해 주세요.” 등 안내.
- Web Share 취소: 별도 메시지 없이 시트/모달만 닫기.

---

## 4. 비기능 요건

- **접근성**: 버튼·시트에 `aria-label`, 키보드 포커스 가능.
- **성능**: 공유 시트는 클라이언트만 사용, 추가 API 호출 없음.
- **호환성**: Web Share API 미지원 브라우저에서는 “링크 복사”만 노출.

---

## 5. UI/UX 가이드

### 5.1 버튼
- 아이콘: `Share2` 또는 `Send`(lucide-react) 등 공유 연상 아이콘.
- 스타일: 기존 찜 버튼과 톤 맞춤(아웃라인 또는 채움). 호버/포커스 시 시각적 피드백.

### 5.2 공유 시트(모바일)
- 하단에서 올라오는 시트 또는 전체 화면 오버레이.
- “닫기” 또는 배경 탭으로 닫기.
- 옵션은 리스트 형태(아이콘 + 라벨).

### 5.3 공유 모달(데스크톱)
- 작은 모달 또는 드롭다운. “링크 복사”가 기본으로 눈에 띄게.
- Web Share 지원 브라우저(일부 데스크톱)에서는 “공유하기”도 표시 가능.

---

## 6. 기술 참고

- **URL 생성**: `window.location.origin + '/listing/' + listingId` 또는 쿼리 포함 시 `window.location.href` 그대로 사용 가능. (쿼리 보존 시에만.)
- **클립보드**: `navigator.clipboard.writeText()` (HTTPS 또는 localhost). 실패 시 `document.execCommand('copy')` 폴백 가능.
- **Web Share**: `navigator.canShare()` / `navigator.share()`. 지원 여부에 따라 “공유하기” 버튼 표시 여부 결정.
- **OG 이미지**: 이미 `listing/[id]` 페이지에 `openGraph.image` 등 설정되어 있으면, 링크 공유 시 카드 미리보기는 기존 메타데이터로 동작.

---

## 7. 추후 확장(선택)

- 공유 URL에 UTM 파라미터 추가(`utm_source=share`, `utm_medium=copy` 등)하여 유입 경로 분석.
- “공유 횟수” 집계(선택): 공유 버튼 클릭 시 로깅 또는 API 호출.
- 카카오톡/인스타그램 등 채널별 딥링크 또는 공식 SDK 연동으로 리치 미리보기 강화.

---

## 8. 완료 조건(체크리스트)

- [ ] 숙소 상세 상단에 “공유” 버튼 노출(찜과 함께).
- [ ] 공유 버튼 클릭 시 공유 시트/모달 표시.
- [ ] “링크 복사” 동작 및 복사 완료/실패 피드백.
- [ ] 모바일에서 Web Share API로 “공유하기” 제공(지원 시).
- [ ] (선택) 카카오톡 공유 링크 또는 채널 버튼.
- [ ] 접근성(aria-label, 키보드) 및 반응형 터치 영역 확인.

---

## 9. 예상 이슈 및 대응

구현 과정 또는 런칭 후 발생할 수 있는 이슈를 미리 정리한 것이다. 설계·구현 시 참고하고, 모니터링 포인트로 활용할 수 있다.

### 9.1 URL·환경

| 이슈 | 원인 | 대응 |
|------|------|------|
| **공유한 링크가 잘못된 도메인으로 열림** | `NEXT_PUBLIC_APP_URL` 미설정 시 코드에서 `https://tokyominbak.example.com` 등 fallback 사용. 스테이징/로컬에서 공유하면 해당 환경 URL이 복사됨. | 배포 환경에 `NEXT_PUBLIC_APP_URL`(실제 서비스 URL) 반드시 설정. 공유 URL 생성 시 클라이언트에서는 `window.location.origin + path` 사용하면 현재 접속 중인 도메인이 그대로 들어가서, 스테이징에서 공유해도 스테이징 링크로 일관됨. (프로덕션만 공유하려면 서버/환경 기준 URL 사용.) |
| **쿼리 포함 URL이 너무 길어짐** | `checkIn`, `checkOut`, `adults`, `children` 등 포함 시 일부 메신저/문자에서 잘리거나 미리보기 실패. | 기본 공유는 “숙소 URL만” 권장. “일정 포함 공유”는 선택 옵션으로 두고, 필요 시 짧은 URL만 복사하도록 안내. |

### 9.2 클립보드·Web Share

| 이슈 | 원인 | 대응 |
|------|------|------|
| **“링크가 복사되지 않는다”** | HTTPS가 아니거나, 비보안 컨텍스트(일부 iframe), iOS Safari 일부 버전에서 `navigator.clipboard` 권한/동작 차이. | 복사 실패 시 `document.execCommand('copy')` 폴백 시도. 그래도 실패하면 “주소창에서 URL을 길게 눌러 복사해 주세요” 등 안내 문구 + 필요 시 URL을 화면에 보여 주기. |
| **iOS Safari에서 복사 후 붙여넣기가 “공유한 페이지 제목”만 나옴** | 일부 앱/OS 버전에서 클립보드에 URL 대신 제목만 저장되는 동작. | 클라이언트에서는 항상 “URL 문자열”만 `writeText`에 넣기. 제목은 Web Share용으로만 사용. |
| **Web Share가 데스크톱에서 안 뜬다** | Chrome 등 일부 데스크톱은 HTTPS에서 지원하지만, Safari/ Firefox 데스크톱은 미지원. | `navigator.share` 존재·`navigator.canShare()` 체크 후 “공유하기” 버튼만 노출. 미지원 시 “링크 복사”만 보이도록 해서 빈 버튼/에러 방지. |
| **공유 시트에서 “취소” 시 에러 로그** | `navigator.share()`가 사용자 취소 시 `AbortError` reject. | `catch`에서 `name === 'AbortError'`이면 무시(토스트 없이 모달만 닫기). 그 외만 “공유에 실패했습니다” 등 표시. |

### 9.3 데이터·상태

| 이슈 | 원인 | 대응 |
|------|------|------|
| **공유한 숙소가 나중에 삭제/비공개됨** | 친구가 링크를 나중에 열었을 때 해당 listing이 삭제되었거나 비공개 처리됨. | 링크 열었을 때 404/notFound면 “해당 숙소를 찾을 수 없습니다” 등 기존 notFound UI로 처리. (공유 기능 자체에서 별도 처리 불필요.) |
| **공유 URL의 날짜가 이미 지남** | 일정 포함 공유 시, 며칠 후 친구가 열면 checkIn/checkOut이 과거. | 예약 폼에서 과거 날짜는 “선택 불가” 등으로 이미 처리되어 있으면, 쿼리만 무시하거나 “이 일정은 지났어요” 문구 정도로 처리. |

### 9.4 UX·접근성

| 이슈 | 원인 | 대응 |
|------|------|------|
| **공유 모달 열린 상태에서 포커스가 버튼 밖으로 나감** | 키보드 사용 시 포커스 트랩이 없으면 배경으로 포커스가 빠짐. | 모달/시트가 열릴 때 첫 번째 포커스 가능 요소에 포커스, Esc로 닫기, 필요 시 포커스 트랩 적용. |
| **“링크가 복사되었습니다” 토스트가 스크린리더에만 읽히고 시각적으로 안 보임** | 토스트가 화면 밖이나 z-index 때문에 가려짐. | 토스트를 페이지 상단 또는 하단 고정 영역에, 적절한 z-index로 표시. `aria-live="polite"`로 읽히게 하되, 시각 디자인도 명확히. |

### 9.5 기타

| 이슈 | 원인 | 대응 |
|------|------|------|
| **카카오톡 공유 시 미리보기 이미지/제목이 안 나옴** | OG 메타가 없거나, 카카오 캐시/크롤러가 아직 안 가져옴. | 현재 listing 페이지에 이미 `openGraph` 설정되어 있으면 유지. 카카오 전용 메타가 필요하면 나중에 Kakao SDK 또는 `og:image` URL 개선으로 확장. |
| **공유 버튼이 찜 버튼과 겹쳐 보이거나 모바일에서 너무 많아짐** | 상단 액션(찜·공유)이 나란히 있을 때 좁은 화면에서 레이아웃 깨짐. | 모바일에서는 아이콘만 노출하거나, 공유를 “…” 메뉴 안으로 넣는 방식 검토. |
